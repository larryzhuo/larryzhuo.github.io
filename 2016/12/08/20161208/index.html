<!DOCTYPE html>
<html lang="">
  <head>
    
<meta charset="UTF-8"/>
<meta name="baidu-site-verification" content="rG4bL5lgLg" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="stf, node"/>




  <meta name="keywords" content="node,stf," />





  <link rel="alternate" href="/default" title="卓凌云的博客">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1" />



<link rel="canonical" href="http://yoursite.com/2016/12/08/20161208/"/>


<meta name="description" content="stf, node">
<meta property="og:type" content="article">
<meta property="og:title" content="Stf源码解读">
<meta property="og:url" content="http://yoursite.com/2016/12/08/20161208/index.html">
<meta property="og:site_name" content="卓凌云的博客">
<meta property="og:description" content="stf, node">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycurub8j21kw0vywwx.jpg">
<meta property="og:image" content="http://ww4.sinaimg.cn/mw690/a5e2541bgw1fafycvajzkj21kw0vy7jy.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycu3csnj21kw0vy1bi.jpg">
<meta property="og:image" content="http://ww4.sinaimg.cn/mw690/a5e2541bgw1fajhxkjr4hj20lo0rmdi0.jpg">
<meta property="og:updated_time" content="2016-12-12T16:10:32.410Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stf源码解读">
<meta name="twitter:description" content="stf, node">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycurub8j21kw0vywwx.jpg">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1" />
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Stf源码解读 - 卓凌云的博客 </title>
    <link rel="manifest" href="manifest.json" />
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">卓凌云的博客</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Stf源码解读
        
      </h1>

      <time class="post-time">
          Dec 8 2016
      </time>
    </header>



    
            <div class="post-content">
            <h3 id="stf源码解读"><a href="#stf源码解读" class="headerlink" title="stf源码解读"></a>stf源码解读</h3><p>stf（smartphone test farm）是一个开源的远程调试工具，这个项目使用到了很多组件如屏幕信息的minicap，屏幕触控的minitouch，消息传递的zeromq等等，非常复杂。简要记录下自己二次开发的过程，值得注意的是整个项目主要就是两个开发者，而且开放了一批周边插件，很厉害。<br>这个项目是B/S模式，浏览器端使用的是angular1+jade编写，服务器端采用的node，构建工具使用的是webpack+gulp。安装环境要求是linux或者mac，我第一次配置感觉还挺复杂，可以看下<a href="https://testerhome.com/topics/2988" target="_blank" rel="external">这篇文章</a>。我们的需求是将#/controls页面中的Devices tab的内容换成屏幕数据的直接展示，这其中遇到了机器bios连接数和多个canvas绘制的性能问题。可以看下我在github上面提的两个issue：</p>
<ol>
<li><a href="https://github.com/openstf/stf/issues/489" target="_blank" rel="external">Not enough host controller resources for new device #489</a></li>
<li><a href="https://github.com/openstf/stf/issues/497" target="_blank" rel="external">A performance issue after i change some code #497</a><br>解决方式我后面会阐述，先看下最终的效果图<br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycurub8j21kw0vywwx.jpg"><br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1fafycvajzkj21kw0vy7jy.jpg"><br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycu3csnj21kw0vy1bi.jpg"><br>功能繁多，我以我如何实现需求进行说明。</li>
</ol>
<h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><p>所有的前端代码在stf/res目录下，后端代码都在stf/lib目录下。我们能快速找到入口js文件res/app/app.js。但是却没有找到入口页面，为什么呢。因为首页是服务器端输出的。在lib/units/app/index.js中可以看到一个典型的express node服务器的代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>)</div><div class="line">app.set(<span class="string">'views'</span>, pathutil.resource(<span class="string">'app/views'</span>))      <span class="comment">//设置views变量，指定视图存放的目录</span></div><div class="line">app.set(<span class="string">'strict routing'</span>, <span class="literal">true</span>)</div><div class="line">app.set(<span class="string">'case sensitive routing'</span>, <span class="literal">true</span>)</div><div class="line">app.set(<span class="string">'trust proxy'</span>, <span class="literal">true</span>)</div><div class="line"><span class="comment">/**/</span></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>设置了模板引擎是pug(jade改名而来)，设置模板存放位置在app/views,设置默认情况下render index（也就是app/views/index.pug）。入口找到了，接下来就看路由设置，熟悉过angular1的人应该都知道路由的定义是要用到$routeProvider的。我们要修改的页面路由是<a href="http://localhost:7100/#!/devices。" target="_blank" rel="external">http://localhost:7100/#!/devices。</a> 然而在app.js中我们看到了这段路由定义<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> .config(<span class="function"><span class="keyword">function</span>(<span class="params">$routeProvider, $locationProvider</span>) </span>&#123;</div><div class="line">  $locationProvider.hashPrefix(<span class="string">'!'</span>)</div><div class="line">  $routeProvider</div><div class="line">    .otherwise(&#123;</div><div class="line">      <span class="attr">redirectTo</span>: <span class="string">'/devices'</span></div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>这里并没有如我所想的$routeProvider.when(‘devices’)。其实这个配置被分到了每个模块之中，比如定义devices路由的在app/device-list/index.js中。相应的也看到了这个路由对象的template和controller<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.config([<span class="string">'$routeProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$routeProvider</span>) </span>&#123;</div><div class="line">  $routeProvider</div><div class="line">    .when(<span class="string">'/devices'</span>, &#123;</div><div class="line">      <span class="attr">template</span>: <span class="built_in">require</span>(<span class="string">'./device-list.pug'</span>),</div><div class="line">      <span class="attr">controller</span>: <span class="string">'DeviceListCtrl'</span></div><div class="line">    &#125;)</div><div class="line">&#125;])</div></pre></td></tr></table></figure></p>
<p>前端代码的架构大概就是这样，分出了很多模块，每个模块中包含了路由配置，模板文件，controller文件，service文件等等。</p>
<h3 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h3><p>前面说了，后端代码都在stf/lib目录下，一般启动stf服务器用的是node bin/stf local。顺着bin/stf文件很轻易找到cli.js。这个文件很重要，使用command.js定义了大量的node命令，这些命令又调用util/procutil.js创建大量进程。我们先看local参数，它的代码太长就不列出来了，可以看出它新建了如下进程，其中app值得app一侧消息处理的进程；dev指是device一侧消息的处理进程：<br>1.’triproxy’, ‘app001’<br>2.’triproxy’, ‘dev001’<br>3.’processor’, ‘proc001’<br>4.’processor’, ‘proc002’<br>5.’reaper’, ‘reaper001’<br>6.’provider’<br>7.auth<br>8.’app’<br>9.’api’<br>10.’websocket’<br>11.’storage’<br>12.’storage-plugin-apk’<br>13.’poorxy’<br>看到这里我就蒙了，还要在github上找了这张结构图，顺着结构图看才能看明白<br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1fajhxkjr4hj20lo0rmdi0.jpg"></p>
<p>以这个场景为例：browser中路由#/control页面中显示手机屏幕画面，滑动屏幕画面，真实设备的画面也随之改变。<br>1.找到该页面对应的模板是app/control-panes/device-control/device-control.pug。<br>2.找到屏幕显示部分是一个device-screen(device=’device’, control=’control’)的指令<br>3.在app/components/screen/screen-directive.js定义了device-screen.可以看到它就是一个canvas。另外在这个指令中使用了websocket连接到服务器端的socket<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(device.display.url)</div><div class="line">ws.binaryType = <span class="string">'blob'</span></div><div class="line"><span class="comment">/****/</span></div><div class="line">ws.onmessage = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">/**/</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">messageListener</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">        screen.rotation = device.display.rotation</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (message.data <span class="keyword">instanceof</span> Blob) &#123;</div><div class="line">          <span class="keyword">if</span> (shouldUpdateScreen()) &#123;</div><div class="line">            <span class="keyword">if</span> (scope.displayError) &#123;</div><div class="line">              scope.$apply(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                scope.displayError = <span class="literal">false</span></div><div class="line">              &#125;)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([message.data], &#123;</div><div class="line">              <span class="attr">type</span>: <span class="string">'image/jpeg'</span></div><div class="line">            &#125;)</div><div class="line"></div><div class="line">            <span class="keyword">var</span> img = imagePool.next()</div><div class="line"></div><div class="line">            img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">              updateImageArea(<span class="keyword">this</span>)</div><div class="line"></div><div class="line">              g.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, img.width, img.height)</div><div class="line"></div><div class="line">              <span class="comment">// Try to forcefully clean everything to get rid of memory</span></div><div class="line">              <span class="comment">// leaks. Note that despite this effort, Chrome will still</span></div><div class="line">              <span class="comment">// leak huge amounts of memory when the developer tools are</span></div><div class="line">              <span class="comment">// open, probably to save the resources for inspection. When</span></div><div class="line">              <span class="comment">// the developer tools are closed no memory is leaked.</span></div><div class="line">              img.onload = img.onerror = <span class="literal">null</span></div><div class="line">              img.src = BLANK_IMG</div><div class="line">              img = <span class="literal">null</span></div><div class="line">              blob = <span class="literal">null</span></div><div class="line"></div><div class="line">              URL.revokeObjectURL(url)</div><div class="line">              url = <span class="literal">null</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            img.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">              <span class="comment">// Happily ignore. I suppose this shouldn't happen, but</span></div><div class="line">              <span class="comment">// sometimes it does, presumably when we're loading images</span></div><div class="line">              <span class="comment">// too quickly.</span></div><div class="line"></div><div class="line">              <span class="comment">// Do the same cleanup here as in onload.</span></div><div class="line">              img.onload = img.onerror = <span class="literal">null</span></div><div class="line">              img.src = BLANK_IMG</div><div class="line">              img = <span class="literal">null</span></div><div class="line">              blob = <span class="literal">null</span></div><div class="line"></div><div class="line">              URL.revokeObjectURL(url)</div><div class="line">              url = <span class="literal">null</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">var</span> url = URL.createObjectURL(blob)</div><div class="line">            img.src = url</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^start /</span>.test(message.data)) &#123;</div><div class="line">          applyQuirks(<span class="built_in">JSON</span>.parse(message.data.substr(<span class="string">'start '</span>.length)))</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (message.data === <span class="string">'secure_on'</span>) &#123;</div><div class="line">          scope.$apply(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            scope.displayError = <span class="string">'secure'</span></div><div class="line">          &#125;)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实际连接多台设备的时候显示每个device.display.url是不同的，其实是每台设备对应对应一个线程，这样是有道理的，多个不同的port有利于突破浏览器的同域下请求数量的限制，提高数据传输量。在onmessage也能看到大量的内存优化，提高垃圾回收效率，传输的blob数据就是屏幕数据，使用windowURL类创建bloburl，然后使用canvas drawImage绘制在画布。</p>
<p>那服务器端怎么建立起websocket服务器端呢？<br>直接看到cli.js启动的provider进程，这个代码在lib/units/provider/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> client = adb.createClient(&#123;</div><div class="line">  <span class="attr">host</span>: options.adbHost</div><div class="line">, <span class="attr">port</span>: options.adbPort</div><div class="line">&#125;)</div><div class="line"><span class="comment">/**********/</span></div><div class="line">client.trackDevices().then(<span class="function"><span class="keyword">function</span>(<span class="params">tracker</span>) </span>&#123;</div><div class="line">  <span class="comment">/**********/</span></div><div class="line">  tracker.on(<span class="string">'add'</span>, filterDevice(<span class="function"><span class="keyword">function</span>(<span class="params">device</span>) </span>&#123;</div><div class="line">    <span class="comment">/**********/</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">spawn</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="comment">/**********/</span></div><div class="line">      <span class="keyword">var</span> allocatedPorts = ports.splice(<span class="number">0</span>, <span class="number">4</span>)</div><div class="line">      <span class="keyword">var</span> proc = options.fork(device, allocatedPorts.slice())</div><div class="line">      <span class="keyword">var</span> resolver = <span class="built_in">Promise</span>.defer()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  tracker.on(<span class="string">'change'</span>, filterDevice(<span class="function"><span class="keyword">function</span>(<span class="params">device</span>) </span>&#123;</div><div class="line">    flippedTracker.emit(device.id, <span class="string">'change'</span>, device)</div><div class="line">  &#125;))</div><div class="line"></div><div class="line">  tracker.on(<span class="string">'remove'</span>, filterDevice(<span class="function"><span class="keyword">function</span>(<span class="params">device</span>) </span>&#123;</div><div class="line">    flippedTracker.emit(device.id, <span class="string">'remove'</span>, device)</div><div class="line">  &#125;))</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/openstf/adbkit" target="_blank" rel="external">adbkit</a>是openstf开源的一个adb的nodejs client。client.trackDevices这个api就可以监听设备的plug和unplug消息。所以这里新设备插入之后会fork出一个新的进程，而这个命令的定义就在cli.js中的’device <serial>‘。这个进程代码就在lib/units/device/index.js。这个文件夹下包含了大量的代码，与屏幕数据相关的代码就在/deivce/screen/stream.js。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">/**************/</span></div><div class="line">  <span class="keyword">var</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123;</div><div class="line">    <span class="attr">port</span>: screenOptions.publicPort</div><div class="line">  , <span class="attr">perMessageDeflate</span>: <span class="literal">false</span></div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> createServer()</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">wss</span>) </span>&#123;</div><div class="line">    <span class="comment">/************/</span></div><div class="line">    wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ws</span>) </span>&#123;</div><div class="line">      <span class="comment">/************/</span></div><div class="line">      <span class="function"><span class="keyword">function</span> <span class="title">wsFrameNotifier</span>(<span class="params">frame</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">          <span class="keyword">switch</span> (ws.readyState) &#123;</div><div class="line">          <span class="keyword">case</span> WebSocket.OPENING:</div><div class="line">            <span class="comment">// This should never happen.</span></div><div class="line">            <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(util.format(</div><div class="line">              <span class="string">'Unable to send frame to OPENING client "%s"'</span>, id)))</div><div class="line">          <span class="keyword">case</span> WebSocket.OPEN:</div><div class="line">            <span class="comment">// This is what SHOULD happen.</span></div><div class="line">            ws.send(frame, &#123;</div><div class="line">              <span class="attr">binary</span>: <span class="literal">true</span></div><div class="line">            &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">              <span class="keyword">return</span> err ? reject(err) : resolve()</div><div class="line">            &#125;)</div><div class="line">            <span class="keyword">return</span></div><div class="line">          <span class="keyword">case</span> WebSocket.CLOSING:</div><div class="line">            <span class="comment">// Ok, a 'close' event should remove the client from the set</span></div><div class="line">            <span class="comment">// soon.</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">          <span class="keyword">case</span> WebSocket.CLOSED:</div><div class="line">            <span class="comment">// This should never happen.</span></div><div class="line">            broadcastSet.remove(id)</div><div class="line">            <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(util.format(</div><div class="line">              <span class="string">'Unable to send frame to CLOSED client "%s"'</span>, id)))</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">      &#125;</div><div class="line">      ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">          <span class="keyword">var</span> match = <span class="regexp">/^(on|off|(size) ([0-9]+)x([0-9]+))$/</span>.exec(data)</div><div class="line">          <span class="keyword">if</span> (match) &#123;</div><div class="line">            <span class="keyword">switch</span> (match[<span class="number">2</span>] || match[<span class="number">1</span>]) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="string">'on'</span>:</div><div class="line">              broadcastSet.insert(id, &#123;</div><div class="line">                <span class="attr">onStart</span>: wsStartNotifier</div><div class="line">              , <span class="attr">onFrame</span>: wsFrameNotifier</div><div class="line">              &#125;)</div><div class="line">              <span class="keyword">break</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'off'</span>:</div><div class="line">              broadcastSet.remove(id)</div><div class="line">              <span class="keyword">break</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'size'</span>:</div><div class="line">              frameProducer.updateProjection(</div><div class="line">                <span class="built_in">Number</span>(match[<span class="number">3</span>]), <span class="built_in">Number</span>(match[<span class="number">4</span>]))</div><div class="line">              <span class="keyword">break</span></div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure></serial></p>
<p>代码太多我就不全列举出来了，这里就是建立了WebSocketServer与前面device-screen中的连接一一对应。发送的on，size，off等消息与这里onmessage正好也对应。broadcastSet用于距离多个连接的数据。wsFrameNotifier中ws.send(frame)就是将数据推送到device-screen中，画面也就在canvas中显示出来了</p>
<p>上面解释了画面怎么显示出来，再来看看滑动画面是怎么传递消息的：<br>前端代码还是在screen-directive.js中，直接找到mouseMoveListener<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**********/</span></div><div class="line">control.touchMove(nextSeq(), <span class="number">0</span>, scaled.xP, scaled.yP, pressure)</div><div class="line"></div><div class="line"><span class="keyword">if</span> (addGhostFinger) &#123;</div><div class="line">  control.touchDown(nextSeq(), <span class="number">1</span>, <span class="number">1</span> - scaled.xP, <span class="number">1</span> - scaled.yP, pressure)</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (deleteGhostFinger) &#123;</div><div class="line">  control.touchUp(nextSeq(), <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (fakePinch) &#123;</div><div class="line">  control.touchMove(nextSeq(), <span class="number">1</span>, <span class="number">1</span> - scaled.xP, <span class="number">1</span> - scaled.yP, pressure)</div><div class="line">&#125;</div><div class="line"></div><div class="line">control.touchCommit(nextSeq())</div></pre></td></tr></table></figure></p>
<p>这个地方的control是control-service:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*************/</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendOneWay</span>(<span class="params">action, data</span>) </span>&#123;</div><div class="line">  socket.emit(action, channel, data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendTwoWay</span>(<span class="params">action, data</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> tx = TransactionService.create(target)</div><div class="line">  socket.emit(action, channel, tx.channel, data)</div><div class="line">  <span class="keyword">return</span> tx.promise</div><div class="line">&#125;</div><div class="line"><span class="comment">/*************/</span></div><div class="line"><span class="keyword">this</span>.touchMove = <span class="function"><span class="keyword">function</span>(<span class="params">seq, contact, x, y, pressure</span>) </span>&#123;</div><div class="line">  sendOneWay(<span class="string">'input.touchMove'</span>, &#123;</div><div class="line">    <span class="attr">seq</span>: seq</div><div class="line">  , <span class="attr">contact</span>: contact</div><div class="line">  , <span class="attr">x</span>: x</div><div class="line">  , <span class="attr">y</span>: y</div><div class="line">  , <span class="attr">pressure</span>: pressure</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的socket是res/app/components/stf/socket/index.js中的socket-service。socket-service中使用socket.io。不同于screen-directive中使用的ws，这两种都是websocket通信的实现，ws模块更加贴近原生js语法。而socket.io则有自己的一套api，socket.emit就是客户端发送消息的api，而node端创建这个socketserver的代码则在lib/units/websocket/index.js中，可以很顺利的在socket.io的监听函数中找到touchMove信息监听。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> push = zmqutil.socket(<span class="string">'push'</span>)</div><div class="line"></div><div class="line"><span class="comment">/***********/</span></div><div class="line">.on(<span class="string">'input.touchMove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel, data</span>) </span>&#123;</div><div class="line">  push.send([</div><div class="line">    channel</div><div class="line">  , wireutil.envelope(<span class="keyword">new</span> wire.TouchMoveMessage(</div><div class="line">      data.seq</div><div class="line">    , data.contact</div><div class="line">    , data.x</div><div class="line">    , data.y</div><div class="line">    , data.pressure</div><div class="line">    ))</div><div class="line">  ])</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>在这里可以看到push socket的消息发送,这已经使用到了zeromq了，有时间另外详细讲解，我们回头看上面贴出来的stf的架构图，现在顺着看下流程。websocket进程中的push将数据推送到triproxy进程的pull中。看下lib/units/triproxy/index.js中的相关代码。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">to</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    to.send([].slice.call(<span class="built_in">arguments</span>))         <span class="comment">//pub分发消息</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// App/device output</span></div><div class="line"><span class="keyword">var</span> pub = zmqutil.socket(<span class="string">'pub'</span>)     <span class="comment">//订阅模式</span></div><div class="line">pub.bindSync(options.endpoints.pub)       <span class="comment">//http://www.cnblogs.com/dvwei/p/3608119.html。pubber绑定一个接口，等待subber的connect</span></div><div class="line">log.info(<span class="string">'PUB socket bound on'</span>, options.endpoints.pub)</div><div class="line"></div><div class="line"><span class="comment">// Coordinator input/output</span></div><div class="line"><span class="keyword">var</span> dealer = zmqutil.socket(<span class="string">'dealer'</span>)     <span class="comment">//dealer是一种更高级的 请求/应答（client/server） 的socket type。它可以自由的收发消息，没有ZMQ_REP/ZMQ_REQ那样的限制。对于每一个连接，接收消息也是使用了公平队列，发送使用了循环队列（RR）。</span></div><div class="line">dealer.bindSync(options.endpoints.dealer)</div><div class="line">dealer.on(<span class="string">'message'</span>, proxy(pub))</div><div class="line">log.info(<span class="string">'DEALER socket bound on'</span>, options.endpoints.dealer)</div><div class="line"></div><div class="line"><span class="comment">// App/device input</span></div><div class="line"><span class="keyword">var</span> pull = zmqutil.socket(<span class="string">'pull'</span>)     <span class="comment">//管道模式</span></div><div class="line">pull.bindSync(options.endpoints.pull)</div><div class="line">pull.on(<span class="string">'message'</span>, proxy(dealer))</div><div class="line">log.info(<span class="string">'PULL socket bound on'</span>, options.endpoints.pull)</div></pre></td></tr></table></figure></p>
<p>pull socket收到消息之后又会调用proxy方法用dealer socket将消息传递出去，对应上图，这个消息被processor进程中的dealer处理了，看下lib/units/processor/index.js相关代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> appDealer = zmqutil.socket(<span class="string">'dealer'</span>)</div><div class="line"><span class="comment">/***************/</span></div><div class="line"><span class="keyword">var</span> devDealer = zmqutil.socket(<span class="string">'dealer'</span>)</div><div class="line"></div><div class="line">appDealer.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel, data</span>) </span>&#123;</div><div class="line">  devDealer.send([channel, data])</div><div class="line">&#125;)</div><div class="line"></div><div class="line">devDealer.on(<span class="string">'message'</span>, wirerouter()</div><div class="line">  .on(<span class="string">''</span>)</div></pre></td></tr></table></figure></p>
<p>processor中包含appDealer和devDealer两种socket。考虑到这不是设备端的消息，另外在devDealer的处理中也并没有看到对touchMove消息的处理，所以这里touchMove的消息是appDealer socket接收，devDealer socket发送出去；看图可以发现消息又被triproxy进程处理，这次是其中的dealer socket处理消息，它又将消息从pub socket中转发出来。这时候又被provider进程和provider创建的一批device子进程处理这批消息。<br>可以在lib/units/device/touch/index.js中最终找到，这个消息的处理<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">router</div><div class="line">  <span class="comment">/*********/</span></div><div class="line">  .on(wire.TouchMoveMessage, <span class="function"><span class="keyword">function</span>(<span class="params">channel, message</span>) </span>&#123;</div><div class="line">    queue.push(message.seq, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      touchConsumer.touchMove(message)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div></pre></td></tr></table></figure></p>
<p>简要的说了下我的理解，至于开头需求的实现，下一篇再讲</p>

            </div>
          

    
      <footer class="post-footer">
        <div class="post-tags">
          
            <a href="/tags/node/">node</a>
          
            <a href="/tags/stf/">stf</a>
          
        </div>

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/04/03/20170403/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Dfs和bfs遍历页面所有元素</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2016/12/08/20170206/">
        <span class="next-text nav-default">基于Openstf Minicap实现的屏幕投影客户端</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
      <div style="text-align:center;">
          <button class="btn" id="load-disqus" onclick="disqus.load();">加载 Disqus 评论</button>
      </div>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = '<%= theme.disqus_shortname%>'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2017
    <span class="footer-author">卓凌云.</span>
    <span class="power-by">
        由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a> 强力驱动
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    

<script type="text/javascript">
  var disqus_shortname = 'larryzhuodisqus';
  var disqus_identifier = '2016/12/08/20161208/';

  var disqus_title = "Stf源码解读";


  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
